<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SLNS Upload</title>
<link rel="stylesheet" href="/style.css">
</head>

<body style="background:#07080a;color:#eaf2f8;padding:20px">

<div style="max-width:980px;margin:20px auto;background:linear-gradient(180deg,#0b0c0e,#0f1215);padding:18px;border-radius:12px">
  
  <h2 style="color:#caa164">Upload New Items (GitHub Auto-Sync)</h2>

  <!-- GitHub Auto-Saved Details -->
  <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;margin-top:10px">
    <input id="owner" placeholder="GitHub Username" style="padding:8px;width:200px">
    <input id="repo" placeholder="Repo Name" style="padding:8px;width:220px">
    <input id="branch" placeholder="Branch" style="padding:8px;width:150px">
  </div>

  <div style="margin-top:6px;color:#9fb0bd;font-size:13px">
    ✔ GitHub details saved automatically  
  </div>

  <!-- Category + Weight -->
  <div style="margin:14px 0">
    <label>Category</label>
    <select id="cat">
      <option>bangles</option>
      <option>bracelet</option>
      <option>chain</option>
      <option>chandraharalu</option>
      <option>earring</option>
      <option>kada</option>
      <option>locket</option>
      <option>necklace</option>
      <option>npchains</option>
      <option>ring</option>
    </select>

    <label style="margin-left:12px">Weight (g)</label>
    <input id="globalWeight" type="number" step="0.001" placeholder="optional" style="width:120px">
  </div>

  <!-- PAT -->
  <input id="pat" type="password"
    placeholder="GitHub Personal Access Token (session only)"
    style="width:100%;padding:8px;margin-top:10px">

  <div style="margin-top:6px;color:#9fb0bd;font-size:13px">
    ✔ PAT saved only for this session (secure)
  </div>

  <!-- File Upload -->
  <input id="files" type="file" multiple accept="image/*" 
    style="margin-top:15px">

  <div id="preview"
    style="display:flex;flex-wrap:wrap;gap:12px;margin-top:15px"></div>

  <button id="publish"
    style="background:#caa164;color:#081126;padding:10px;border-radius:8px;margin-top:18px">
      Publish All to GitHub
  </button>

  <div id="status" style="margin-top:12px;color:#9fb0bd"></div>
</div>

<script>
// ==========================
// SECURITY & ADMIN CHECK
// ==========================
if (sessionStorage.getItem('slns_admin') !== 'true') {
  window.location.href = '/dashboard/';
}

// ==========================
// AUTO-SAVE GITHUB DETAILS
// ==========================
const ownerEl = document.getElementById("owner");
const repoEl  = document.getElementById("repo");
const branchEl = document.getElementById("branch");
const patEl = document.getElementById("pat");

// Load saved values
ownerEl.value  = localStorage.getItem("github_owner")  || "slnsjewellers22-bot";
repoEl.value   = localStorage.getItem("github_repo")   || "slns-digital-catalogue";
branchEl.value = localStorage.getItem("github_branch") || "main";

// Save automatically
[ownerEl, repoEl, branchEl].forEach(input => {
  input.addEventListener("input", () => {
    localStorage.setItem("github_" + input.id, input.value.trim());
  });
});

// ==========================
// PAT (session only)
// ==========================
patEl.value = sessionStorage.getItem("github_pat") || "";
patEl.addEventListener("input", () => {
  sessionStorage.setItem("github_pat", patEl.value.trim());
});

// ==========================
// IMAGE PREVIEW
// ==========================
const filesInput = document.getElementById("files");
const preview = document.getElementById("preview");
let selectedFiles = [];

filesInput.addEventListener("change", e => {
  selectedFiles = Array.from(e.target.files);
  preview.innerHTML = "";

  selectedFiles.forEach(f => {
    const box = document.createElement("div");
    box.style.width = "140px";
    box.style.padding = "8px";
    box.style.background = "#071018";
    box.style.borderRadius = "8px";

    const img = document.createElement("img");
    img.src = URL.createObjectURL(f);
    img.style.width = "100%";
    img.style.height = "100px";
    img.style.objectFit = "cover";

    const name = document.createElement("div");
    name.textContent = f.name;
    name.style.color = "#eaf2f8";
    name.style.fontSize = "12px";

    box.appendChild(img);
    box.appendChild(name);
    preview.appendChild(box);
  });
});

// ==========================
// UPLOAD FUNCTION
// ==========================
async function publishToGitHub() {

  const owner  = ownerEl.value.trim();
  const repo   = repoEl.value.trim();
  const branch = branchEl.value.trim() || "main";
  const pat    = patEl.value.trim();
  const cat    = document.getElementById("cat").value;
  const globalWeight = parseFloat(document.getElementById("globalWeight").value) || 0;

  if (!owner || !repo || !pat) {
    alert("Enter GitHub owner, repo and PAT");
    return;
  }
  if (selectedFiles.length === 0) {
    alert("Choose images to upload");
    return;
  }

  document.getElementById("status").textContent = "Uploading...";

  // Load existing items.json
  let items = [];
  try {
    const resp = await fetch(`https://raw.githubusercontent.com/${owner}/${repo}/${branch}/items.json?no-cache=${Date.now()}`);
    if (resp.ok) items = await resp.json();
  } catch (e) {
    items = [];
  }

  // Upload each file
  for (let file of selectedFiles) {

    const id = file.name.replace(/\.[^/.]+$/, "");
    const path = `images/${id}.jpg`;

    // Convert image to base64
    const b64 = await toBase64(file);

    // Upload image
    const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
    const body = {
      message: `Add ${path}`,
      content: b64.split(",")[1],
      branch
    };

    const res = await fetch(url, {
      method: "PUT",
      headers: {
        Authorization: "token " + pat,
        Accept: "application/vnd.github.v3+json"
      },
      body: JSON.stringify(body)
    });

    if (res.status === 201 || res.status === 200) {
      // Success
      const rawURL = `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${path}`;

      items.push({
        id,
        name: id.replace(/_/g, " "),
        metal: "gold",
        category: cat,
        weight: globalWeight,
        imageURL: rawURL,
        timestamp: Date.now()
      });

      document.getElementById("status").textContent = `Uploaded: ${file.name}`;
    } else {
      alert(`Upload failed for ${file.name}`);
    }
  }

  // Update items.json
  const itemsPath = "items.json";
  const encoded = btoa(unescape(encodeURIComponent(JSON.stringify(items, null, 2))));

  const urlItems = `https://api.github.com/repos/${owner}/${repo}/contents/${itemsPath}`;
  const bodyItems = {
    message: "Update items.json",
    content: encoded,
    branch
  };

  const res2 = await fetch(urlItems, {
    method: "PUT",
    headers: {
      Authorization: "token " + pat,
      Accept: "application/vnd.github.v3+json"
    },
    body: JSON.stringify(bodyItems)
  });

  if (res2.status === 200 || res2.status === 201) {
    document.getElementById("status").textContent = "✔ Upload Complete — items.json updated";
  } else {
    alert("Failed to update items.json");
  }

}

function toBase64(file) {
  return new Promise((res, rej) => {
    const r = new FileReader();
    r.onload = () => res(r.result);
    r.onerror = err => rej(err);
    r.readAsDataURL(file);
  });
}

document.getElementById("publish").addEventListener("click", publishToGitHub);
</script>

</body>
</html>
